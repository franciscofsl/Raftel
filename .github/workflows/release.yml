name: Release to GitHub Packages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Restore previous version tracker
        uses: actions/cache@v4
        with:
          path: .github/version_tracker.txt
          key: version-tracker-${{ github.repository }}
          restore-keys: |
            version-tracker-${{ github.repository }}

      - name: Calculate version
        id: version
        run: |
          YEAR=$(date +'%Y')
          MONTH=$(date +'%m')
          VERSION_FILE=".github/version_tracker.txt"
          
          mkdir -p .github
          touch $VERSION_FILE

          LAST_LINE=$(grep -v '^#' $VERSION_FILE | tail -n 1 2>/dev/null || echo "")
          LAST_MONTH=$(echo $LAST_LINE | cut -d':' -f1)
          LAST_NUMBER=$(echo $LAST_LINE | cut -d':' -f2)
          
          if [ -z "$LAST_NUMBER" ] || [ "$LAST_MONTH" != "${YEAR}${MONTH}" ]; then
            COUNTER=0
          else
            COUNTER=$((LAST_NUMBER + 1))
          fi
          
          VERSION="${YEAR}.${MONTH}.$(printf "%02d" $COUNTER)"
          echo "${YEAR}${MONTH}:${COUNTER}" >> $VERSION_FILE
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

      - name: Save version tracker
        uses: actions/cache/save@v4
        with:
          path: .github/version_tracker.txt
          key: version-tracker-${{ github.repository }}-${{ steps.version.outputs.version }}

      - name: Build
        run: dotnet build -c Release

      - name: Pack and publish all NuGet projects
        run: |
          VERSION=${{ steps.version.outputs.version }}
          for csproj in $(find src -name "*.csproj"); do
            echo "ðŸ“¦ Packing $csproj with version $VERSION"
            dotnet pack "$csproj" -c Release -p:PackageVersion=$VERSION --no-build --output .
          done

          for pkg in $(find . -maxdepth 1 -name "*.nupkg"); do
            echo "ðŸš€ Publishing $pkg"
            dotnet nuget push "$pkg" \
              --api-key ${{ secrets.GITHUB_TOKEN }} \
              --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" \
              --skip-duplicate
          done
